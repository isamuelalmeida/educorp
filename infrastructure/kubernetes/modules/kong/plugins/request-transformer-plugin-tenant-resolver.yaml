apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: request-transformer-tenant-resolver
  annotations:
    kubernetes.io/ingress.class: kong
  labels:
    global: "true"
config:
  add:
    headers:
      - tenantId:$((function()
          local host = headers.Host
          if (host:find("posonline.upf.br")) then
            return "upf"
          elseif (host:find("posead.umc.br")) then
            return "umc"
          elseif (host:find("posonline.utp.br")) then
            return "utp"
          end
          local subdomain = host:match("//([^/]+)")
          if (subdomain == nil or subdomain == '') then
            subdomain = host:match("([^/]+)")
          end
          local tenant = subdomain:match("([^.]+)")
          if (tenant == nil or tenant == '') then
            tenant = "DEFAULT"
          end
          return tenant
        end)())
plugin: request-transformer